# Руководство по выбору LLM-моделей для агентов и субагентов

> Практическое руководство по оптимальному использованию разных моделей в вашей системе оркестрации агентов.

## Оглавление

- [Общие принципы](#общие-принципы)
- [Классы моделей](#классы-моделей)
- [Быстрая справка по агентам](#быстрая-справка-по-агентам)
- [Настройка в Cursor](#настройка-в-cursor)
- [Оптимизация бюджета](#оптимизация-бюджета)

---

## Общие принципы

### 1. High-Stakes → Флагман
**Когда использовать:** Архитектура, безопасность, миграции, схемы БД, PHI/HIPAA  
**Почему:** Цена ошибки намного выше стоимости токенов  
**Модели:** GPT-5.2, Claude Sonnet 4.5, Claude Opus 4.5

### 2. Research & Docs → Балансная модель
**Когда использовать:** Документация, спеки, продуктовые концепции, длинные тексты  
**Почему:** Нужно качество синтеза и структурирования  
**Модели:** Claude Sonnet 4.5, GPT-5.2

### 3. Routine & Speed → Дешёвая модель
**Когда использовать:** Поиск по коду, автодополнение, чистка комментов, CI/CD  
**Почему:** Много мелких вызовов, низкая цена ошибки  
**Модели:** GPT-4.x-mini, Claude Haiku, Llama 3.1 8B

### 4. Кастомные модели
**Когда использовать:** Длинное reasoning без требований к polish  
**Почему:** Экономия при сохранении качества мышления  
**Модели:** DeepSeek-R1, Llama Nemotron 40-70B

---

## Классы моделей

### Флагманы (Flagship Models)

| Модель | Сила | Слабость | Цена токена |
|--------|------|----------|-------------|
| **GPT-5.2** | Код, reasoning, техника | Иногда verbose | $$$ |
| **Claude Opus 4.5** | Максимальный IQ, документы | Самая дорогая | $$$$ |
| **Claude Sonnet 4.5** | Баланс, документы, UX | Чуть медленнее GPT | $$$ |

**Используй для:**
- Архитектурные решения (CTO, Technical Architect)
- Безопасность и HIPAA compliance (Security Agent)
- Сложные миграции и рефакторинг (.NET Migration)
- RFM-аналитика и ClickHouse схемы (Analytics Agent)

### Балансные модели

| Модель | Сила | Слабость | Цена токена |
|--------|------|----------|-------------|
| **GPT-4.5 / 4.1** | Универсальность | Дороже mini | $$ |
| **Claude Sonnet 4.5** | Документация, UX | — | $$ |

**Используй для:**
- Продуктовые навыки (CPO, HoPD, HoPD Design)
- Документация и спеки (Documentation Agent)
- Дашборды и визуализация (Dashboard Agent)
- Сценарии коммуникаций (Scenario Designer)

### Быстрые модели

| Модель | Сила | Слабость | Цена токена |
|--------|------|----------|-------------|
| **GPT-4.x-mini** | Скорость, стоимость | Меньше reasoning | $ |
| **Claude Haiku** | Скорость | Ограниченная доступность | $ |
| **Llama 3.1 8B** | Кастомный хостинг | Качество ниже | FREE |

**Используй для:**
- Поиск по коду (`explore` субагент)
- Очистка комментариев (Comment Cleaner)
- CI/CD конфиги (DevOps Helper)
- QA чек-листы (QA Agent, типовые)
- Release чек-листы (Release Master, routine)

### Кастомные reasoning-модели

| Модель | Сила | Слабость | Где хостить |
|--------|------|----------|-------------|
| **DeepSeek-R1** | Сильный reasoning, дешёвый | Качество текста | API / OpenRouter |
| **Llama Nemotron 70B** | Reasoning, OpenSource | Требует GPU | Локально / Together |

**Используй для:**
- Длинное архитектурное планирование
- Альтернатива флагманам для внутренних задач
- Экспериментирование с reasoning

---

## Быстрая справка по агентам

### Стратегические Skills (флагманы)

| Skill | Основная модель | Альтернатива | Reasoning |
|-------|----------------|--------------|-----------|
| **cto-copilot** | GPT-5.2 / Claude Sonnet 4.5 | DeepSeek-R1 | Критичные технические решения |
| **cpo-copilot** | GPT-5.2 / Claude Sonnet 4.5 | Claude Opus 4.5 | Продуктовая стратегия C-level |
| **head-of-product-design** | Claude Sonnet 4.5 / GPT-5.2 | Claude Opus 4.5 | UX стратегия, дизайн-системы |
| **release-master** | GPT-4.x-mini | Claude Sonnet 4.5 | Routine → mini, Major → флагман |

### Архитектурные агенты (флагманы)

| Agent | Основная модель | Альтернатива | Reasoning |
|-------|----------------|--------------|-----------|
| **technical-architect** | GPT-5.2 / Claude Sonnet 4.5 | DeepSeek-R1 | Системный дизайн, интеграции |
| **security-privacy** | GPT-5.2 / Claude Opus 4.5 | — | HIPAA compliance, zero tolerance |
| **dotnet-migration** | GPT-5.2 / Claude Sonnet 4.5 | DeepSeek-R1 | Миграция критичной логики |

### Аналитические агенты (балансные + быстрые)

| Agent | Основная модель | Быстрая альтернатива | Reasoning |
|-------|----------------|----------------------|-----------|
| **analytics-data-modeling** | GPT-5.2 / Claude Sonnet 4.5 | GPT-4.x-mini | Сложные SQL → флагман, простые → mini |
| **dashboard-visualization** | Claude Sonnet 4.5 / GPT-5.2 | — | UX + техническая спека |

### Документация и спеки (балансные)

| Agent | Основная модель | Для тяжёлых RFC | Reasoning |
|-------|----------------|-----------------|-----------|
| **documentation-specs** | Claude Sonnet 4.5 / GPT-5.2 | Claude Opus 4.5 | Качество текста, API-спеки |
| **scenario-messaging** | Claude Sonnet 4.5 / GPT-5.2 | Claude Opus 4.5 | Эмпатия, patient journeys |

### DevOps и QA (быстрые + балансные)

| Agent | Основная модель | Для сложных задач | Reasoning |
|-------|----------------|-------------------|-----------|
| **ci-cd-devops** | GPT-4.x-mini | Claude Sonnet 4.5 / GPT-5.2 | Типовое → mini, сложное → флагман |
| **qa-test-design** | GPT-4.x-mini | GPT-5.2 / Claude Sonnet 4.5 | Routine → mini, RFM/PHI → флагман |

### Утилитарные агенты (быстрые)

| Agent | Основная модель | Reasoning |
|-------|----------------|-----------|
| **human-like-comment-cleaner** | GPT-4.x-mini / Llama 3.1 8B | Стилистика, много мелких вызовов |

### Субагенты (Task)

| Subagent Type | Модель | Reasoning |
|---------------|--------|-----------|
| **explore** | GPT-4.x-mini / быстрая кастомная | Частые короткие запросы по коду |
| **generalPurpose** | GPT-5.2 | Многошаговые задачи, сложное reasoning |
| **research-copilot** | Claude Sonnet 4.5 / GPT-5.2 | Синтез внешних знаний, long context |

---

## Настройка в Cursor

### 1. Базовая настройка моделей

1. Открой **Cursor Settings** (Cmd+, или Ctrl+,)
2. Перейди в раздел **Models**
3. Настрой API ключи для:
   - OpenAI (для GPT-5.2, GPT-4.x-mini)
   - Anthropic (для Claude Sonnet 4.5, Opus 4.5)
   - Опционально: кастомный OpenAI-совместимый endpoint

### 2. Настройка кастомных моделей

Для добавления DeepSeek-R1, Llama или других через OpenRouter/Together:

```json
// В Cursor Settings → Custom Models
{
  "openai.api_key": "your-openrouter-key",
  "openai.api_base": "https://openrouter.ai/api/v1",
  "cursor.models": [
    {
      "name": "DeepSeek-R1",
      "model": "deepseek/deepseek-r1",
      "apiKey": "${openai.api_key}",
      "apiBase": "${openai.api_base}"
    }
  ]
}
```

### 3. Выбор модели для агента

В Cursor при вызове агента можно явно указать модель:

```typescript
// Пример вызова через Task tool
Task({
  subagent_type: "technical-architect-system-design",
  model: "gpt-5.2", // или "claude-sonnet-4.5"
  prompt: "Design architecture for RFM dashboard module"
})
```

### 4. Переопределение модели в настройках агента

Каждый агент в `.cursor/agents/*.md` теперь имеет секцию `Recommended LLM Model`.
Cursor автоматически использует эти рекомендации, но ты можешь переопределить:

```yaml
# В агенте можно добавить override
---
name: my-custom-agent
default_model: gpt-5.2
fallback_model: claude-sonnet-4.5
---
```

---

## Оптимизация бюджета

### Стратегия 1: Умное переключение

**Правило:** Начинай с дешёвой модели, переключайся на дорогую только при необходимости.

**Примеры:**
- **QA Agent:** GPT-4.x-mini для smoke-тестов → GPT-5.2 для RFM/security тестов
- **Release Master:** GPT-4.x-mini для routine releases → Claude Sonnet 4.5 для major
- **Analytics:** GPT-4.x-mini для простых SELECT → GPT-5.2 для материализованных представлений

### Стратегия 2: Кастомные модели для reasoning

**DeepSeek-R1** через OpenRouter стоит значительно дешевле GPT-5.2/Claude Opus:
- **Используй для:** Архитектурное планирование, длинное мышление, внутренние RFC
- **Не используй для:** User-facing документация (качество текста ниже)

### Стратегия 3: Кеширование и переиспользование

**Снижай токены через:**
1. **Context reuse:** Передавай только выводы от агентов, не весь transcript
2. **Caching:** Используй кеш для повторяющихся запросов (explore субагент)
3. **Summaries:** Создавай краткие summary вместо передачи полных логов

### Стратегия 4: Мониторинг использования

**Отслеживай:**
- Какие агенты жрут больше всего токенов
- Где можно заменить флагман на mini
- Где стоит добавить кастомную модель

**Инструменты:**
- OpenAI Usage Dashboard
- Anthropic Console
- Cursor Analytics (если доступно)

### Примерная стоимость по агентам

| Агент | Вызовов/день | Токены/вызов | Модель | Стоимость/месяц |
|-------|--------------|--------------|--------|-----------------|
| **explore** | 100 | 500 | GPT-4.x-mini | $5 |
| **cto-copilot** | 10 | 5000 | GPT-5.2 | $50 |
| **security-privacy** | 5 | 3000 | Claude Opus 4.5 | $30 |
| **comment-cleaner** | 50 | 1000 | GPT-4.x-mini | $3 |
| **analytics** | 20 | 4000 | GPT-5.2 + mini | $40 + $5 |

**Итого:** ~$133/месяц при активном использовании.

**Оптимизация:**
- Замена флагманов на DeepSeek-R1 где возможно: **-40%**
- Кеширование повторяющихся запросов: **-20%**
- **Финальная стоимость:** ~$75/месяц

---

## Практические рекомендации

### Когда обязательно использовать флагман

1. **Безопасность и PHI**
   - Security reviews
   - HIPAA compliance проверки
   - Audit trail дизайн

2. **Архитектурные решения**
   - Выбор технологического стека
   - Системный дизайн
   - Миграции и рефакторинг

3. **Критичная бизнес-логика**
   - RFM расчёты и сегментация
   - Материализованные представления
   - Сложные SQL оптимизации

4. **Продуктовая стратегия C-level**
   - CPO/CTO решения
   - Roadmap planning
   - Major releases

### Когда можно использовать дешёвую модель

1. **Рутинные операции**
   - Поиск файлов и функций
   - Автодополнение
   - Форматирование кода

2. **Стилистические задачи**
   - Очистка комментариев
   - Линтинг и prettier

3. **Типовые конфиги**
   - GitHub Actions workflows
   - Docker compose
   - Простые CI/CD пайплайны

4. **Базовые тест-кейсы**
   - Smoke tests
   - Простые регрессионные наборы

### Когда переключаться на более мощную модель

**Признаки, что нужен upgrade:**
1. Модель даёт неполные или неточные ответы
2. Требуется глубокий reasoning с несколькими шагами
3. Задача касается безопасности или критичной логики
4. Нужна высокая точность в расчётах или схемах

**Как переключиться:**
```typescript
// Если первый результат неудовлетворителен
Task({
  resume: previous_agent_id,
  model: "gpt-5.2", // upgrade с mini на flagship
  prompt: "Continue with deeper analysis"
})
```

---

## Обновление этого руководства

При добавлении новых агентов или изменении моделей:

1. Обнови секцию **Recommended LLM Model** в `.cursor/agents/*.md`
2. Добавь запись в таблицу **Быстрая справка по агентам**
3. Пересчитай **Примерную стоимость** если нужно
4. Обнови `.cursorrules` если изменились общие принципы

---

## Вопросы и ответы

### В: Можно ли смешивать модели в одной цепочке агентов?

**Да!** Например:
1. CPO (GPT-5.2) → формулирует стратегию
2. HoPD Design (Claude Sonnet 4.5) → создаёт UX-концепцию
3. Technical Architect (GPT-5.2) → проектирует архитектуру
4. Comment Cleaner (GPT-4.x-mini) → чистит финальный код

### В: Что если у меня нет доступа к GPT-5.2 или Claude Opus?

**Используй доступные аналоги:**
- GPT-5.2 → GPT-4.1 Code / GPT-4.5
- Claude Opus 4.5 → Claude Sonnet 4.5
- Кастомные: DeepSeek-R1, Llama 3.1 70B через OpenRouter

### В: Как понять, что модель слишком слабая для задачи?

**Признаки:**
1. Неполные или поверхностные ответы
2. Пропуск edge cases
3. Галлюцинации в критичных местах (SQL, security)
4. Непонимание сложных зависимостей

**Решение:** Переключись на более мощную модель для этого агента.

### В: Стоит ли использовать DeepSeek-R1 для всего?

**Нет.** DeepSeek-R1 отлично подходит для:
- Длинного reasoning
- Архитектурного планирования
- Внутренних технических документов

**Не подходит для:**
- User-facing документация (качество текста)
- Когда важен polish и tone (Claude лучше)
- Критичные security reviews (Claude Opus / GPT-5.2 надёжнее)

---

## Заключение

Правильный выбор модели — это баланс между **качеством**, **скоростью** и **стоимостью**.

**Золотое правило:**
> Используй дорогие модели для high-stakes задач, где ошибка дорого стоит.  
> Экономь на рутинных операциях с низкой ценой ошибки.

Следуй рекомендациям в этом руководстве, но не бойся экспериментировать и находить свой оптимальный баланс для конкретного проекта.

---

**Дата создания:** 2026-01-25  
**Версия:** 1.0  
**Авторы:** Sergej Pilipenko + Claude Sonnet 4.5
