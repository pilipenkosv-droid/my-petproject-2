# Обновление: Человекочитаемые сообщения об ошибках форматирования

## Цель

Сделать комментарии в документе с найденными нарушениями форматирования более понятными для пользователей, заменив технические термины на русские человекочитаемые формулировки.

## Что изменилось

### До изменений:
```
Неверное выравнивание текста: ожидается "justify", найдено "center"
Неверный размер шрифта: ожидается "14 pt", найдено "12 pt"
Неверный межстрочный интервал: ожидается "1.5", найдено "1.0"
```

### После изменений:
```
Неверное выравнивание текста: ожидается "по ширине", найдено "по центру"
Неверный размер шрифта: ожидается "14 пт", найдено "12 пт"
Неверный межстрочный интервал: ожидается "полуторный", найдено "одинарный"
```

## Реализация

### 1. Создан новый модуль утилит форматирования
**Файл:** `src/lib/utils/formatting-messages.ts`

Модуль содержит функции для преобразования технических значений в человекочитаемый формат:

- `formatAlignment()` - выравнивание (left → по левому краю, center → по центру, и т.д.)
- `formatFontSize()` - размер шрифта (14 pt → 14 пт)
- `formatLineSpacing()` - межстрочный интервал (1.5 → полуторный)
- `formatIndent()` - отступы (унификация формата)
- `formatMargin()` - поля страницы
- `formatQuoteType()` - типы кавычек (angular → угловые кавычки «»)
- `formatDashType()` - типы тире (em-dash → длинное тире (—))
- `formatSpaceType()` - типы пробелов (nbsp → неразрывный пробел)
- **`formatViolationMessage()`** - главная функция, автоматически определяющая тип правила и применяющая нужное форматирование

### 2. Обновлён модуль форматирования документов
**Файл:** `src/lib/pipeline/document-formatter.ts`

Функция создания комментариев теперь использует `formatViolationMessage()` для преобразования сообщений:

```typescript
// Было:
const violationTexts = paragraphViolations
  .map(v => `${v.message}: ожидается "${v.expected}", найдено "${v.actual}"`)
  .join("\n");

// Стало:
const violationTexts = paragraphViolations
  .map(v => formatViolationMessage(v.message, v.expected, v.actual, v.ruleId))
  .join("\n");
```

### 3. Добавлены тесты
**Файл:** `src/lib/utils/__tests__/formatting-messages.test.ts`

Полное покрытие тестами всех функций форматирования для обеспечения корректности преобразований.

### 4. Создана документация
**Файл:** `docs/formatting-messages-examples.md`

Подробные примеры всех преобразований с таблицей соответствий технических и человекочитаемых значений.

## Поддерживаемые типы преобразований

| Категория | Примеры преобразований |
|-----------|------------------------|
| Выравнивание | justify → по ширине, center → по центру, left → по левому краю, right → по правому краю |
| Размер шрифта | 14 pt → 14 пт, 12 pt → 12 пт |
| Интервал | 1.0 → одинарный, 1.5 → полуторный, 2.0 → двойной |
| Кавычки | angular → угловые кавычки «», straight → прямые кавычки "" |
| Тире | em-dash → длинное тире (—), en-dash → среднее тире (–), hyphen → дефис (-) |
| Пробелы | nbsp → неразрывный пробел, space → обычный пробел |

## Как это работает

1. При анализе документа система находит нарушения форматирования
2. Каждое нарушение имеет `ruleId` (например, `text-align-5`, `text-spacing-10`)
3. Функция `formatViolationMessage()` анализирует `ruleId` и определяет тип правила
4. На основе типа применяется соответствующее форматирование к полям `expected` и `actual`
5. Результат вставляется в комментарий Word в исходном документе

## Обратная совместимость

Все изменения полностью обратно совместимы. Если `ruleId` не распознан или значение не имеет специального форматирования, оно отображается в исходном виде.

## Тестирование

Запуск тестов (если настроен Jest):
```bash
npm test formatting-messages
```

Проверка сборки:
```bash
npm run build
```

## Примеры использования

### В коде:

```typescript
import { formatViolationMessage } from "@/lib/utils/formatting-messages";

const message = formatViolationMessage(
  "Неверное выравнивание текста",
  "justify",
  "center", 
  "text-align-5"
);
// Результат: "Неверное выравнивание текста: ожидается "по ширине", найдено "по центру""
```

### В документе Word:

Пользователь увидит комментарий с понятным описанием:

> ⚠️ **Нарушения форматирования**
> 
> Неверное выравнивание текста: ожидается "по ширине", найдено "по центру"  
> Неверный размер шрифта: ожидается "14 пт", найдено "12 пт"  
> Неверный межстрочный интервал: ожидается "полуторный", найдено "одинарный"

## Дальнейшие улучшения

- [ ] Добавить поддержку локализации (i18n) для других языков
- [ ] Расширить список форматирований для дополнительных типов правил
- [ ] Добавить настройки уровня детализации сообщений (кратко/подробно)
- [ ] Добавить интеграционные тесты с реальными документами

## Авторы

SmartFormat Team

## Дата обновления

25 января 2026
